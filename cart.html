<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>House of Greens — Checkout</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root {
      --accent: #1fb6a5; --accent-dark: #179483; --bg: #fff; --muted: #6b7280;
      --card: #f6f9f8; --text: #0f1724; --muted-light: #e6efec; --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
    .container { max-width: 1100px; margin: 28px auto; padding: 0 18px; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--muted-light); background: #fff; position: sticky; top: 0; z-index: 50; }
    .logo { font-weight: 800; color: var(--accent); font-size: 1.15rem; text-decoration: none; }
    .grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--muted-light); margin-bottom: 16px; }
    h3 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

    /* Cart Item Styles */
    .cart-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee; align-items: center; }
    .item-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; background: #eee; }
    .item-info { flex: 1; }
    .qty-ctrl { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
    .qty-btn { width: 26px; height: 26px; border: 1px solid var(--muted-light); background: #fff; border-radius: 4px; cursor: pointer; }
    .remove-btn { color: var(--danger); font-size: 0.75rem; cursor: pointer; background: none; border: none; text-decoration: underline; margin-left: 10px; }

    /* Payment Styles */
    .pay-opt { border: 1px solid var(--muted-light); padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; background: #fff; position: relative; }
    .pay-opt.active { border-color: var(--accent); background: #f0f9f8; }
    .copy-row { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-top: 8px; border: 1px solid #eee; }
    .copy-addr { font-family: monospace; font-size: 0.85rem; word-break: break-all; font-weight: bold; }
    .copy-btn { background: var(--accent); color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }

    input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--muted-light); border-radius: 8px; font-family: inherit; }
    .btn { background: var(--accent); color: #fff; border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; }
    .hidden { display: none; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .total-row { display: flex; justify-content: space-between; font-weight: 900; font-size: 1.2rem; border-top: 1px solid #ddd; padding-top: 12px; color: var(--accent); }
    
    #success-overlay { position: fixed; inset: 0; background: #fff; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; }
  </style>
</head>
<body>

<header>
  <a href="index.html" class="logo">HOUSE OF GREENS</a>
</header>

<div class="container">
  <div class="grid">
    <div class="left-col">
      <div class="card">
        <h3>1. Your Items</h3>
        <div id="cart-container">Loading products...</div>
      </div>

      <div class="card">
        <h3>2. Delivery Information</h3>
        <input type="text" id="cust_name" placeholder="Full Name *" required>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input type="email" id="cust_email" placeholder="Email Address *" required>
          <input type="tel" id="cust_tel" placeholder="Phone Number *" required>
        </div>
        
        <div style="margin:15px 0; display:flex; align-items:center; gap:10px; background: #f0f9f8; padding: 12px; border-radius: 8px;">
          <input type="checkbox" id="need_shipping" style="width:auto; margin:0; cursor:pointer;">
          <label for="need_shipping" style="font-weight:600; cursor:pointer;">Require Shipping? (+$20.00)</label>
        </div>

        <div id="shipping-section" class="hidden">
          <input type="text" id="cust_address" placeholder="Street Address">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="cust_city" placeholder="City">
            <input type="text" id="cust_postal" placeholder="Postal Code">
          </div>
        </div>
        <textarea id="cust_notes" placeholder="Order notes (optional)"></textarea>
      </div>

      <div class="card">
        <h3>3. Payment Method</h3>
        <div class="pay-opt active" onclick="setPay('BTC', this)">
          <strong>Bitcoin (BTC)</strong>
          <input type="radio" name="pay_mode" checked style="float:right">
          <div id="btc-box" class="copy-row">
            <span id="btc-addr" class="copy-addr">1H7QyCp7Htpf329CEb2pzj6a4JYGHtm6bD</span>
            <button class="copy-btn" onclick="copyAddr('btc-addr')">COPY</button>
          </div>
        </div>
        
        <div class="pay-opt" onclick="setPay('CashApp/Zelle', this)">
          <strong>CashApp / Zelle</strong>
          <input type="radio" name="pay_mode" style="float:right">
          <div id="other-pay-box" class="hidden" style="margin-top:10px; font-size:0.9rem; color:var(--muted);">
            <p>Please place your order first. After clicking "Place Order", contact our <strong>Live Chat Support</strong> to receive the payment handles.</p>
          </div>
        </div>
      </div>
    </div>

    <aside>
      <div class="card" style="position: sticky; top: 100px;">
        <h3>Order Summary</h3>
        <div class="summary-row"><span>Subtotal:</span> <span id="sum-sub">$0.00</span></div>
        <div class="summary-row"><span>Shipping:</span> <span id="sum-ship">$0.00</span></div>
        <div class="total-row"><span>Total:</span> <span id="sum-total">$0.00</span></div>
        <button class="btn" id="finalize-btn" style="margin-top:20px;" onclick="submitOrder()">PLACE ORDER</button>
      </div>
    </aside>
  </div>
</div>

<div id="success-overlay">
  <div style="font-size: 60px;">✅</div>
  <h1 style="color:var(--accent)">Order Received!</h1>
  <p style="font-size: 1.1rem;">Support will contact you shortly to confirm your order.</p>
  <p><strong>Please contact Support via Live Chat now for immediate confirmation.</strong></p>
  <button class="btn" onclick="location.href='index.html'" style="max-width:220px; margin-top:30px;">Back to Homepage</button>
</div>

<script>
const EMAILJS_USER_ID     = 'uxpve7I9VNOBYVeuT';
const EMAILJS_SERVICE_ID  = 'Testing';
const EMAILJS_TEMPLATE_ID = 'Testing911';

(function() { emailjs.init(EMAILJS_USER_ID); })();

const CART_KEY = 'hog_cart';
let products = [];
let selectedMethod = 'BTC';

async function init() {
  try {
    const res = await fetch('products.json');
    const data = await res.json();
    products = Array.isArray(data) ? data : (data.products || []);
    renderCart();
  } catch (e) { console.error("Error loading products", e); }
}

function renderCart() {
  const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  const container = document.getElementById('cart-container');
  const needShip = document.getElementById('need_shipping').checked;
  
  if(!cart.length) {
    container.innerHTML = `<p style="text-align:center;">Your cart is empty.</p>`;
    document.getElementById('finalize-btn').disabled = true;
    return;
  }

  let subtotal = 0;
  container.innerHTML = '';

  cart.forEach((item, index) => {
    const prod = products.find(p => String(p.id) === String(item.id));
    const name = prod ? prod.name : (item.name || "Product");
    const img = prod ? prod.image : 'store.jpg';
    
    const priceNum = parseFloat(String(item.price).replace(/[^0-9.]/g, '')) || 0;
    const itemTotal = priceNum * (item.qty || 1);
    subtotal += itemTotal;

    container.innerHTML += `
      <div class="cart-item">
        <img src="${img}" class="item-img" onerror="this.src='store.jpg'">
        <div class="item-info">
          <span style="font-weight:700;display:block;">${name}</span>
          <span style="font-size:0.8rem;color:var(--muted)">${item.size} — $${priceNum.toFixed(2)}</span>
          <div class="qty-ctrl">
            <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
            <span style="font-weight:bold;margin:0 5px">${item.qty}</span>
            <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
            <button class="remove-btn" onclick="removeItem(${index})">Remove</button>
          </div>
        </div>
        <div style="font-weight:700;">$${itemTotal.toFixed(2)}</div>
      </div>`;
  });

  const shipFee = needShip ? 20 : 0;
  document.getElementById('sum-sub').innerText = `$${subtotal.toFixed(2)}`;
  document.getElementById('sum-ship').innerText = `$${shipFee.toFixed(2)}`;
  document.getElementById('sum-total').innerText = `$${(subtotal + shipFee).toFixed(2)}`;
}

function updateQty(idx, delta) {
  let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  cart[idx].qty = Math.max(1, (cart[idx].qty || 1) + delta);
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  renderCart();
}

function removeItem(idx) {
  let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  cart.splice(idx, 1);
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  renderCart();
}

document.getElementById('need_shipping').addEventListener('change', () => {
  document.getElementById('shipping-section').classList.toggle('hidden', !document.getElementById('need_shipping').checked);
  renderCart();
});

function setPay(method, el) {
  selectedMethod = method;
  document.querySelectorAll('.pay-opt').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('btc-box').classList.toggle('hidden', method !== 'BTC');
  document.getElementById('other-pay-box').classList.toggle('hidden', method !== 'CashApp/Zelle');
}

function copyAddr(id) {
  const text = document.getElementById(id).innerText;
  navigator.clipboard.writeText(text).then(() => { alert("Address copied!"); });
}

async function submitOrder() {
  const name = document.getElementById('cust_name').value.trim();
  const email = document.getElementById('cust_email').value.trim();
  const tel = document.getElementById('cust_tel').value.trim();
  const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');

  if(!name || !email || !tel) return alert("Please fill in contact info.");
  if(!cart.length) return alert("Cart is empty.");

  const btn = document.getElementById('finalize-btn');
  btn.disabled = true;
  btn.innerText = "Processing...";

  // 1. Format items into a readable string
  let itemsFormatted = "";
  cart.forEach(item => {
    const prod = products.find(p => String(p.id) === String(item.id));
    const pName = prod ? prod.name : "Product";
    itemsFormatted += `${pName} (${item.size}) x${item.qty} - $${(item.price * item.qty).toFixed(2)}\n`;
  });

  // 2. Format the full address
  let fullAddress = "Pickup Order";
  if(document.getElementById('need_shipping').checked) {
    const addr = document.getElementById('cust_address').value;
    const city = document.getElementById('cust_city').value;
    const zip = document.getElementById('cust_postal').value;
    fullAddress = `${addr}, ${city}, ${zip}`;
  }

  const templateParams = {
    from_name: name,
    from_email: email,
    phone: tel,
    method: selectedMethod,
    total: document.getElementById('sum-total').innerText,
    address: fullAddress,
    items: itemsFormatted, 
    notes: document.getElementById('cust_notes').value || "No notes"
  };

  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
    localStorage.removeItem(CART_KEY);
    document.getElementById('success-overlay').style.display = 'flex';
  } catch (err) {
    alert("Error sending order.");
    btn.disabled = false;
    btn.innerText = "PLACE ORDER";
  }
}

init();
</script>
</body>
</html>
